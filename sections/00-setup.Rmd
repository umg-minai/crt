```{r knitr_setup, include = FALSE}
frf <- function(...)
    rprojroot::find_root_file(..., criterion = ".editorconfig", path = ".")

knitr::opts_chunk$set(
    cache.path = frf("cache", knitr::opts_knit$get('rmarkdown.pandoc.to'), "/")
)
```

```{r package_bibliography, include = FALSE}
knitr::write_bib(
    c(
        "base",
        "gtsummary",
        "survival",
        "survminer"
    ),
    file = frf("bibliography", "rpackages.bib")
)
```

```{r libraries, include = FALSE}
library("survival")
library("gtsummary")
library("survminer")
library("DiagrammeR")
library("DiagrammeRsvg")
```

```{r definitions, include = FALSE}
## manufacturer's colors
mcol <- c(
    Arrow = "#115dce",
    Braun = "#108f34",
    Vygon = "#8f061a"
)

## days of interest
times <- c(1, 3, 5, 7, 9, 11, 13)
```

```{r import, include = FALSE}
cvc <- read.csv(frf("data", "extdata", "cvc.csv"))
```
```{r abbreviations, include = FALSE}
abbr <- setNames(character(ncol(cvc)), colnames(cvc))

## labels where the column names are identical to the abbreviation
abbr["BMI"] <- "body mass index"
abbr["DVT"] <- "deep vene thrombosis"
abbr <- c(abbr,
    WBC = "white blood counts",
    CRP = "C-related peptide",
    FV = "femoral vene",
    IJV = "internal jugular vene",
    SCV = "subclavian vene",
    DOAC = "direct oral anticoagulation",
    LMWH = "low molecular weight heparin",
    UFH = "unfractionated heparin"
)
```

```{r conversion, include = FALSE}
cvc$FirstExam <- as.numeric(cvc$FirstExam)

fcts <- c(
    "Sex", "Manufacturer", "Site", "Side", "Incision", "Attempts2",
    "Speciality", "AdmissionType",
    "AnticoagulationGroup"
)
cvc[fcts] <- lapply(cvc[fcts], as.factor)

cvc$Experience[!nchar(cvc$Experience)] <- NA
cvc$Experience <- factor(
    cvc$Experience,
    levels = c("<25", "25-50", ">50"),
    ordered = TRUE
)
```

```{r preparation, include = FALSE}
cvc$ExclusionReason[cvc$Site != "IJV"] <-
    paste("Site:", as.character(cvc$Site[cvc$Site != "IJV"]))
cvc$ExclusionReason[cvc$Lumens == 4] <- "Lumen: 4"
cvc$ExclusionReason[cvc$Lumens == 7] <- "Lumen: 7"
cvc$ExclusionReason[cvc$Manufacturer == "Braun" & cvc$Lumens == 5] <-
    "Lumen: 5, Braun"
cvc$ExclusionReason[duplicated(cvc$CaseId)] <- "Not the first CVC"
cvc$ExclusionReason[cvc$AnticoagulationGroup == "DOAC"] <- "Anticoagulation: DOAC"

cvc$isExcluded <- !is.na(cvc$ExclusionReason)
```

```{r modelhelper, include = FALSE}
.followup <- function(x)ifelse(x$CRT, x$CRTday, x$FollowUp)
.modelbylumen <- function(x, nlumens) {
    x <- x[x$Lumens == nlumens & !x$isExcluded,]
    x$CRT <- x$CRT == "CRT"
    x$FUP <- .followup(x)

    svf <- survfit(Surv(FUP, CRT) ~ Manufacturer, data = x)
    svd <- survdiff(Surv(FUP, CRT) ~ Manufacturer, data = x, rho = 0)

    list(data = x, svf = svf, svd = svd)
}

.modelbymanufacturer <- function(x, manufacturer) {
    x <- x[x$Manufacturer == manufacturer & !x$isExcluded,]
    x$CRT <- x$CRT == "CRT"
    x$FUP <- .followup(x)

    svf <- survfit(Surv(FUP, CRT) ~ Lumens, data = x)
    svd <- survdiff(Surv(FUP, CRT) ~ Lumens, data = x, rho = 0)

    list(data = x, svf = svf, svd = svd)
}

.nrisk <- function(x, times = c(1, 3, 5, 7, 9, 11, 13)) {
    ncol <- 2L
    m <- matrix(
        NA_real_,
        ncol = ncol, nrow = length(times),
        dimnames = list(times, gsub("^.*=", "", names(x$srv$strata)))
    )
    sm <- summary(x$srv, times = times)
    m[seq_along(sm$n.risk)] <- sm$n.risk
    m
}

.ncumevents <- function(x, times = c(1, 3, 5, 7, 9, 11, 13)) {
    ncol <- 2L
    m <- matrix(
        NA_real_,
        ncol = ncol, nrow = length(times),
        dimnames = list(times, gsub("^.*=", "", names(x$srv$strata)))
    )
    sm <- summary(x$srv, times = times)
    m[seq_along(sm$n.event)] <- sm$n.event
    apply(m, 2, cumsum)
}
```

```{r model3, include = FALSE}
ml3 <- .modelbylumen(cvc, 3)
```

```{r model5, include = FALSE}
ml5 <- .modelbylumen(cvc, 5)
```

```{r modelA, include = FALSE}
mlA <- .modelbymanufacturer(cvc, "Arrow")
```

```{r helper, include = FALSE}
.medLU <- function(x) {
    q <- quantile(x, probs = c(0.5, 0.25, 0.75), na.rm = TRUE)
    sprintf("%.1f (%.1f, %.1f)", q[1L], q[2L], q[3L])
}
```
