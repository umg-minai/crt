```{r knitr_setup, include = FALSE}
frf <- function(...)
    rprojroot::find_root_file(..., criterion = ".editorconfig", path = ".")

knitr::opts_chunk$set(
    cache.path = frf("cache", knitr::opts_knit$get('rmarkdown.pandoc.to'), "/")
)
```

```{r package_bibliography, include = FALSE}
knitr::write_bib(
    c(
        "base",
        "consort",
        "gtsummary",
        "survival",
        "survminer"
    ),
    file = frf("bibliography", "rpackages.bib")
)
```

```{r libraries, include = FALSE}
library("survival")
library("gtsummary")
library("survminer")
```

```{r definitions, include = FALSE}
## manufacturer's colors
mcol <- c(
    Arrow = "#115dce",
    Braun = "#108f34",
    Vygon = "#8f061a"
)
## lumen's lty; survplot just supports integer values
llty <- c(
    "3 Lumens" = 3L, # == "dotted",
    "4 Lumens" = 4L, # == "dotdash",
    "5 Lumens" = 1L  # == "solid"
)

## days of interest
times <- c(1, 3, 5, 7, 9, 11, 13)
```

```{r import, include = FALSE}
cvc <- read.csv(frf("data", "extdata", "cvc.csv"))
```

```{r abbreviations, include = FALSE}
abbr <- setNames(character(ncol(cvc)), colnames(cvc))

## labels where the column names are identical to the abbreviation
abbr["BMI"] <- "body mass index"
abbr["DVT"] <- "deep vene thrombosis"
abbr <- c(abbr,
    WBC = "white blood counts",
    CRP = "C-related peptide",
    FV = "femoral vene",
    IJV = "internal jugular vene",
    SCV = "subclavian vene",
    DOAC = "direct oral anticoagulation",
    LMWH = "low molecular weight heparin",
    UFH = "unfractionated heparin",
    OR = "operating room",
    PE = "pulmonary embolism",
    CLABSI = "central line associated bloodstream infection"
)
```

```{r conversion, include = FALSE}
cvc$FirstExam <- as.numeric(cvc$FirstExam)

fcts <- c(
    "Sex", "Manufacturer", "Site", "Side", "External", "Incision",
    "PerioperativePlacement", "Speciality", "AdmissionType",
    "DVT", "DVT.CVC", "Sepsis", "Cancer", "Smoking",
    "AnticoagulationGroup", "Complications"
)
cvc[fcts] <- lapply(cvc[fcts], as.factor)

cvc$Attempts2 <- factor(
    ifelse(
        is.na(cvc$Attempts), NA, ifelse(cvc$Attempts > 1, ">1", "1")
    ), levels = c("1", ">1")
)

cvc$Experience[!nchar(cvc$Experience)] <- NA
cvc$Experience <- factor(
    cvc$Experience,
    levels = c("<25", "25-50", ">50"),
    ordered = TRUE
)

cvc$ManLu <- factor(paste0(cvc$Manufacturer, cvc$Lumens))

cvc$Side <- relevel(cvc$Side, ref = "right")
cvc$AdmissionType <- relevel(cvc$AdmissionType, ref = "surgical")
cvc$AnticoagulationGroup <- relevel(cvc$AnticoagulationGroup, ref = "LMWH")
cvc$Complications <- relevel(cvc$Complications, ref = "None")
```

```{r exclusion, include = FALSE}
cvc$ExclusionReason[cvc$Site != "IJV"] <-
    paste("Site:", as.character(cvc$Site[cvc$Site != "IJV"]))

cvc$ExclusionReason[cvc$External == "yes"] <- paste("Not inserted in-house")

nManLu <- table(cvc$ManLu)
isLowN <- cvc$ManLu %in% names(nManLu)[nManLu < 5]
cvc$ExclusionReason[isLowN] <-
    paste0("Lumen: ", cvc$Lumens[isLowN], ", ", cvc$Manufacturer[isLowN])
cvc$ExclusionReason[cvc$ManLu == "Arrow5" & grepl("ARROWgard", cvc$Type)] <- 
    "Lumen: 5, Arrow"

cvc$ExclusionReason[cvc$AnticoagulationGroup == "DOAC"] <- "Anticoagulation: DOAC"
cvc$ExclusionReason[duplicated(cvc$CaseId)] <- "Not the first CVC"

cvc$isExcluded <- !is.na(cvc$ExclusionReason)
```

```{r tbl1, include = FALSE}
.manlu2txt <- function(x)paste0(
    substring(x, 1, 5), "/", substring(x, 6, 6), " Lumens"
)

tbl1 <- cvc |>
    dplyr::filter(!isExcluded) |>
    droplevels() |>
    dplyr::mutate(
        ManLu = factor(
            ManLu,
            levels = levels(.data$ManLu),
            labels = .manlu2txt(levels(.data$ManLu))
        )
    ) |>
    select(
        CRT,
        Sex,
        Age,
        BMI,
        ManLu,
        Side,
        Incision,
        Attempts2,
        Experience,
        PerioperativePlacement,
        FirstExam,
        FollowUp,
        AdmissionType,
        Speciality,
        Sepsis,
        Cancer,
        DVT,
        Smoking,
        AnticoagulationGroup,
        Complications,
        WBC1,
        CRP1,
        DDimer1
    ) |>
    tbl_summary(
        by = CRT,
        missing_text = "(Missing)",
        type = list(
            FollowUp ~ "continuous",
            Sex ~ "dichotomous",
            DVT ~ "dichotomous",
            Side ~ "dichotomous",
            Attempts2 ~ "dichotomous",
            AnticoagulationGroup ~ "categorical"
        ),
        label = list(
            FollowUp ~ "Follow-up time [days]",
            FirstExam ~ "Time to first exam [hours]",
            Sex ~ "Sex (male)",
            ManLu ~ "Type (Manufacturer/Lumens)",
            DVT ~ "History of venous thrombosis",
            Side ~ "Side of insertion (left)",
            Experience ~ "Experience (number of CVCs in the past)",
            Attempts2 ~ "More than one insertion attempt",
            PerioperativePlacement ~ "Placement outside the OR",
            AnticoagulationGroup ~ "Type of anticoagulation drug",
            WBC1 ~ "WBC day 1 [Gpt/L]",
            DDimer1 ~ "D-dimer day 1 [mg/L]",
            CRP1 ~ "CRP day 1 [mg/L]"
        ),
        value = list(
            Sex ~ "male",
            DVT ~ "yes",
            Side ~ "left",
            Attempts2 ~ ">1",
            Incision ~ "yes"
        )
    ) |>
    add_overall() |>
    add_p(test.args = c(Speciality) ~ list(simulate.p.value = TRUE))

uvar <- unique(c(tbl1$table_body$variable, tbl1$table_body$label))
.abbr <- sort(c(Filter(nchar, abbr[uvar]), OR = "operating room"))

tbl1 <-  tbl1 |>
    modify_caption(
    paste0(
        "Baseline characteristics of all analysed central venous catheters ",
        "in the internal jugular vene.<br />",
        "Values are given as ",
        "median (lower quartile - upper quartile) or n (percent).<br />",
        paste(names(.abbr), .abbr, sep = ", ", collapse = "; ")
    )
)
```

```{r helper, include = FALSE}
.followup <- function(x)ifelse(x$CRT, x$CRTday, x$FollowUp)
.model <- function(x) {
    x <- x[!x$isExcluded,]
    x$CRT <- x$CRT == "CRT"
    x$FUP <- .followup(x)

    svf <- survfit(Surv(FUP, CRT) ~ ManLu, data = x)
    svd <- survdiff(Surv(FUP, CRT) ~ ManLu, data = x, rho = 1)

    list(data = x, svf = svf, svd = svd)
}

#' @param svf survfit object
#' @param times numeric, times to evaluate
.survsummary <- function(svf, times, type = c("n.event", "n.risk")) {
    type <- match.arg(type, several.ok = TRUE)
    ntype <- length(type)

    ntimes <- length(times)
    nlvls <- length(svf$strata)
    sm <- summary(svf, times = times, extend = TRUE)

    a <- array(
        data = NA_real_,
        dim = c(ntimes, nlvls, ntype),
        dimnames = list(times, names(svf$strata), type)
    )
    a[, , ] <- unlist(sm[type])
    a
}

.nrisk <- function(svf, times = c(1, 3, 5, 7, 9, 11, 13)) {
    .survsummary(svf, times, type = "n.risk")
}

.ncumevents <- function(svf, times = c(1, 3, 5, 7, 9, 11, 13)) {
    a <- .survsummary(svf, times, type = "n.event")
    apply(a, 2, cumsum)
}

.medLU <- function(x, prec=".1") {
    q <- quantile(x, probs = c(0.5, 0.25, 0.75), na.rm = TRUE)
    sprintf(
        paste0("%", prec, "f (%", prec, "f, %", prec, "f)"),
        q[1], q[2], q[3]
    )
}

.medCI <- function(x, prec=".1") {
    q <- quantile(
        x, probs = 0.5, na.rm = TRUE, conf.int = TRUE
    )
    sprintf(
        paste0("%", prec, "f (%", prec, "f-%", prec, "f)"),
        q$quantile, q$lower, q$upper
    )
}
```

```{r model, include = FALSE}
m <- .model(cvc)
```

```{r regression, include = FALSE}
rd <- droplevels(m$data)
rd$WBC1 <- log(rd$WBC1)
rd$CRP1 <- log(rd$CRP1)
rd$DDimer1 <- log(rd$DDimer1 + 1)

## complete cases
rgcx <- coxph(
    Surv(FUP, CRT) ~
        Sex + Age + ManLu +
        Side + PerioperativePlacement +
        Sepsis + Cancer + DVT + AnticoagulationGroup,
    data = rd
)

rd$Experience <- factor(rd$Experience, ordered = FALSE)
rd.na <- na.omit(rd[c(
    "FUP", "CRT", "Sex", "Age", "BMI", "ManLu", "Side",
    "PerioperativePlacement", "Incision", "Attempts2", "Experience",
    "Speciality", "Sepsis", "Cancer", "DVT", "AnticoagulationGroup",
    "WBC1", "DDimer1", "CRP1")]
)

## all variables (reduced N, due to NA)
rgcx.full <- coxph(Surv(FUP, CRT) ~ ., data = rd.na)
```

```{r glmnet, include = FALSE}
#x <- model.matrix(
#    Surv(FUP, CRT) ~
#        Sex + Age + BMI + ManLu +
#        Side + PerioperativePlacement +
#        Incision + Experience +
#        Sepsis + Cancer + DVT + DVT.CVC +
#        AnticoagulationGroup + WBC1,
#    data = rd
#)[, -1]
#i <- rownames(rd) %in% rownames(x)
#y <- Surv(rd$FUP[i], rd$CRT[i])
#fit <- ameld::rcv.glmnet(x = x, y = y, family = "cox")
#coef(fit, s = "lambda.min")
```
