# Figures

## Flowchart

```{r consort-flowchart, echo = FALSE, fig.width = 12, fig.cap = "The flowchart depicts the inclusion and exclusion criteria. CVC, central venous catheter; FV, femoral vene; SCV, subclavian vene."}
library("consort")

.txt <- function(label, n)paste0(label, "\n (n = ", n, ")")
narms <- table(cvc$ManLu[!cvc$isExcluded])
narms <- narms[narms > 0]
arms <- .manlu2txt(names(narms))
excl <- table(cvc$ExclusionReason)
eord <- c(
    grep("Site", names(excl)),
    grep("Lumen", names(excl))
)
eord <- c(seq_len(length(excl))[eord], seq_len(length(excl))[-eord])
excl <- excl[eord]
excl <- paste0(
    "Excluded (n = ", sum(excl), ")",
    paste0("\n\u2022 ", names(excl), " (n = ", excl, ")", collapse = "")
)

cnsrt <-
    add_box(txt = .txt("Screened CVCs", nrow(cvc))) |>
    add_side_box(txt = excl) |>
    add_box(txt = .txt("Eligible CVCs", sum(!cvc$isExcluded))) |>
    add_split(txt = .txt(arms, narms)) |>
    add_label_box(txt = c(
        "1" = "Enrollment",
        "2" = "Allocation",
        "3" = "Analysis")
    )
plot(cnsrt)
```

## Survival plots

```{r survivalplothelper, include = FALSE}
## taken from ameld

#' Plot method for 'survfit' objects
#'
#' This is just a wrapper method around [`survival::plot.survfit()`] with
#' custom defaults.
#'
#' @param x `survfit` object.
#' @param main `character(1)`, plot title.
#' @param xlab `character(1)`, x-axis label.
#' @param ylab `character(1)`, y-axis label.
#' @param mark.time `logical(1)`, if `TRUE` censoring times are marked, see
#' [`survival::plot.survfit()`] for details.
#' @param conf.int `logical(1)`, if `TRUE` confidence interval is plotted, see
#' [`survival::plot.survfit()`] for details.
#' @param col `integer`/`character`, specifying colors for each curve.
#' @param times `integer`, vector of times to print on the x-axis.
#' @param \dots further arguments passed to [`survival::plot.survfit()`].
#'
#' @return a list with `x` and `y` containing the coordinates of the last point
#' of each curves.
#'
#' @seealso [`survival::plot.survfit()`]
#'
#' @import survival
#' @importFrom graphics axTicks axis text title
#' @importFrom grDevices palette.colors
#' @export
#' @examples
#' library("survival")
#' srvfit <- survfit(Surv(time, status) ~ x, data = aml)
#' plot_surv(srvfit)
plot_surv <- function(
    x,
    main = character(),
    xlab = "Time",
    ylab = "Overall survival probability",
    mark.time = TRUE,
    conf.int = FALSE,
    col = palette.colors(max(1L, length(x$strata))),
    times,
    ...) {
    if (!inherits(x, "survfit"))
        stop("'x' has to be an object of the 'survfit' class.")
    p <- plot(
        x,
        mark.time = mark.time, conf.int = conf.int, col = col,
        axes = FALSE, ann = FALSE,
        ...
    )
    if (missing(times))
        times <- axTicks(1L)
    title(main = main, adj = 0L)
    title(xlab = xlab, adj = 1L)
    title(ylab = ylab, adj = 1L)
    axis(1L, at = times, lwd.ticks = 0L, col = "#808080")
    axis(2L, lwd.ticks = 0L, col = "#808080")
    invisible(p)
}

#' Plot a table
#'
#' Plot a table on the current graphic device. Useful for risk tables.
#'
#' @param x `matrix`, it is transposed on the graphic device. The column names
#' correspond to the y labels and the row names to the x labels.
#' @param main `character(1)`, plot title.
#' @param xlab `character(1)`, x-axis label.
#' @param ylab `character(1)`, y-axis label.
#' @param at `numeric, where to plot the rows of `x`.
#' @param xlim `numeric(2)`, limits of the x-axis.
#' @param ylim `numeric(2)`, limits of the y-axis.
#' @param ylabels `logical(1)`, should the column names used to labels the
#' y-axis (default: `TRUE`)?
#' @param col `integer`/`character`, specifying the color for each y/column
#' label.
#' @param xaxis `logical(1)`, should the x-axis be plotted (default: `TRUE`)?
#' @param cex.xaxis `numeric(1)`, character expansion factor for the x-axis
#' labels, see [`par()`] for details.
#' @param cex.yaxis `numeric(1)`, character expansion factor for the y-axis
#' labels, see [`par()`] for details.
#' @param cex.text `numeric(1)`, character expansion factor for the cell content
#' labels, see [`par()`] for details.
#' @param \dots further arguments passed to [`plot.default()`].
#'
#' @return nothing, used for its side-effects (plotting).
#'
#' @export
#' @examples
#' m <- matrix(
#'     1:8, nrow = 4,
#'     dimnames = list(c(0, 30, 90, 365), LETTERS[1:2])
#' )
#' plot_table(m, main = "Cumulative number of events")
plot_table <- function(
    x,
    main = character(),
    xlab = character(),
    ylab = character(),
    at = seq_len(nrow(x)) - 1L,
    xlim = range(at),
    ylim = c(0L, ncol(x)),
    ylabels = TRUE,
    col = rep_len(1L, ncol(x)),
    xaxis = TRUE,
    cex.xaxis = 3/4,
    cex.yaxis = 1.25,
    cex.text = 1.5,
    ...
    ) {
    plot(
        NA,
        xlim = xlim,
        ylim = ylim,
        axes = FALSE, ann = FALSE,
        ...
    )
    title(main = main, adj = 0L)
    title(xlab = xlab, adj = 1L)
    title(ylab = ylab, adj = 1L)
    if (xaxis)
        axis(1L, at = at, cex.axis = cex.xaxis, lwd.ticks = 0L, col = "#808080")
    nc <- ncol(x)
    if (ylabels) {
        nm <- colnames(x)
        for (i in seq_len(nc)) {
            axis(
                side = 2L,
                at = (i - 1L), padj = -1L, las = 1L, labels = nm[i],
                col.axis = col[i], cex.axis = cex.yaxis, tick = FALSE
            )
        }
    }
    text(
        at, rep(seq_len(nc) - 1L, each = length(at)), pos = 3L,
        labels = x, cex = cex.text
    )
}
```

```{r survplot, echo = FALSE, fig.width = 12, fig.height = 8, fig.cap = "Survival plot showing CRT-free time for all analysed central venous catheters."}
old.par <- par(no.readonly = TRUE)
xlim <- c(0.8, max(times))
mar <- c(0.1, 10.1, 1.1, 2.1)
nms <- .manlu2txt(gsub("ManLu=", "", names(m$svf$strata)))
col <- mcol[sapply(strsplit(nms, "/", fixed = TRUE), "[[", 1)]
lty <- llty[sapply(strsplit(nms, "/", fixed = TRUE), "[[", 2)]
names(col) <- names(lty) <- nms

layout(matrix(1:3, nrow = 3), height = c(6, 1.5, 1.5))
par(mar = c(5.1, mar[-1]))
plot_surv(
    m$svf,
    times = times,
    xlim = xlim,
    ylim = c(0, 1),
    mark.time = FALSE,
    col = col,
    lty = lty,
    lwd = 1,
    main = "Thrombus free time of CVCs",
    xlab = "time [days]"
)
#points(
#    median(m$svf), rep(0.5, length(nms)),
#    col = "black", lty = "dotted", type = "h"
#)
legend(
    "topright",
    legend = nms,
    col = col, lty = lty,
    lwd = 1, seg.len = 3, bty = "n"
)

.revcol <- function(x)x[, rev(seq_len(ncol(x)))]
nr <- drop(.nrisk(m$svf))
nce <- drop(.ncumevents(m$svf))
colnames(nr) <- colnames(nce) <- nms
nr <- .revcol(nr)
nce <- .revcol(nce)

par(mar = mar)
plot_table(
    nr, at = times, xlim = xlim,
    main = "Number at risk",
    xaxis = FALSE, cex.text = 1.5, col = col[colnames(nr)]
)
par(mar = mar)
plot_table(
    nce, at = times, xlim = xlim,
    main = "Cumulative number of events",
    xaxis = FALSE, cex.text = 1.5, col = col[colnames(nce)]
)
```

## Regression

```{r forestplot, echo = FALSE, fig.width = 12, fig.height = 8, fig.cap = "Hazard ratios"}
ml <- cvc[!cvc$isExcluded,]
ml$CRT <- ml$CRT == "CRT"
ml$FUP <- .followup(ml)
ml$Side <- relevel(ml$Side, ref = "right")
ml$PerioperativePlacement <- factor(ml$PerioperativePlacement, levels = c("no", "yes"))
ml$Lumens <- factor(ml$Lumens)
ml$Experience <- factor(ml$Experience, levels = c("<25", "25-50", ">50"), ordered = FALSE)
ml$Attempts2 <- droplevels(factor(ml$Attempts2, levels = c("1", ">1", "NA")))
ml$Incision <- droplevels(factor(ml$Incision, levels = c("no", "yes", "NA")))
ml$Sepsis <- factor(ml$Sepsis, levels = c(0, 1), labels = c("no", "yes"))
ml$Cancer <- factor(ml$Cancer, levels = c(0, 1), labels = c("no", "yes"))
ml$AdmissionType <- relevel(ml$AdmissionType, ref = "surgical")
ml$AnticoagulationGroup <- droplevels(ml$AnticoagulationGroup)
ml$AnticoagulationGroup <- relevel(ml$AnticoagulationGroup, ref = "LMWH")
ml$WBC1 <- log(ml$WBC1)
ml$CRP1 <- log(ml$CRP1)
ml$DDimer1 <- log(ml$DDimer1)
ml$DDimer1[is.infinite(ml$DDimer1)] <- NA

rgcx <- coxph(
    Surv(FUP, CRT) ~
        Sex + Age + BMI + Manufacturer + Lumens +
        Side + PerioperativePlacement + PerioperativePlacement +
        Sepsis + Cancer + DVT + AnticoagulationGroup,
    data = ml
)
rgcx

ggforest(rgcx, data = ml)
```

```{r forestplot2, echo = FALSE, fig.width = 12, fig.height = 8}
rgcxlab <- coxph(
    Surv(FUP, CRT) ~
        Sex + Age + BMI + Manufacturer + Lumens +
        Side + Attempts2 + Incision + Experience + PerioperativePlacement +
        AdmissionType + Sepsis + Cancer + DVT + AnticoagulationGroup +
        WBC1 + CRP1 + DDimer1,
    data = ml
)
rgcxlab
ggforest(rgcxlab, data = ml)
```
